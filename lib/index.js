var Promise,crypto,digest,fs,getLocalFiles,getRemoteFiles,getUploadFiles,glob,path,s3,uploadFiles;crypto=require("crypto"),fs=require("fs"),path=require("path"),Promise=require("es6-promise").Promise,glob=require("glob"),s3=require("./s3"),digest=function(e){var t;return t=crypto.createHash("md5"),t.update(e),t.digest("hex")},getLocalFiles=function(e,t){var r;return r=t.root,new Promise(function(t,n){return glob(e,function(e,s){var c;return null!=e?n(e):(c=s.reduce(function(e,t){return e.concat([{key:"/"+path.relative(r,t),path:path.resolve(t)}])},[]).filter(function(e){return fs.statSync(e.path).isFile()}).map(function(e){var t,r;return t=e.key,r=e.path,{key:t,path:r,digest:digest(fs.readFileSync(r,{}))}}),t(c))})})},getRemoteFiles=function(e){var t,r,n,s,c;return t=e.accessKeyId,r=e.bucketName,c=e.secretAccessKey,s=e.region,n=s3({accessKeyId:t,secretAccessKey:c,region:s}),n.listAllObjects({Bucket:r}).then(function(e){return e.map(function(e){return{key:e.Key,digest:JSON.parse(e.ETag)}})})},getUploadFiles=function(e,t){return e.filter(function(e){return t.every(function(t){return e.key!==t.key||e.digest!==t.digest})})},uploadFiles=function(e,t){var r,n,s,c,o;return r=t.accessKeyId,n=t.bucketName,o=t.secretAccessKey,c=t.region,s=s3({accessKeyId:r,secretAccessKey:o,region:c}),s.putAllObjects(e,{Bucket:n})},module.exports=function(e,t){var r,n,s,c;return null==t.root&&(t.root=process.cwd()),null==t.bucketName&&(t.bucketName=null),null==t.accessKeyId&&(t.accessKeyId=process.env.AWS_ACCESS_KEY_ID),null==t.secretAccessKey&&(t.secretAccessKey=process.env.AWS_SECRET_ACCESS_KEY),null==t.region&&(t.region=null!=(n=process.env.AWS_REGION)?n:"ap-northeast-1"),r=[],s=[],c=[],Promise.resolve().then(function(){return getLocalFiles(e,{root:t.root})}).then(function(e){return r=e}).then(function(){return getRemoteFiles(t)}).then(function(e){return s=e}).then(function(){return getUploadFiles(r,s)}).then(function(e){return c=e}).then(function(){return uploadFiles(c,t)})};