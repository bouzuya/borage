var Promise,crypto,digest,fs,getLocalFiles,getRemoteFiles,getUploadFiles,glob,newS3Client,path,s3,uploadFiles;crypto=require("crypto"),fs=require("fs"),path=require("path"),Promise=require("es6-promise").Promise,glob=require("glob"),s3=require("./s3"),digest=function(e){var t;return t=crypto.createHash("md5"),t.update(e),t.digest("hex")},newS3Client=function(e){var t,n;e={};for(t in e)n=e[t],e[t]=n;return e.apiVersion="2006-03-01",new S3(e)},getLocalFiles=function(e,t){var n;return n=t.cwd,new Promise(function(t,r){return glob(e,{cwd:n},function(e,s){var c;return null!=e?r(e):(c=s.reduce(function(e,t){return e.concat([{key:"/"+path.relative(n,t),path:path.join(n,t)}])},[]).filter(function(e){return fs.statSync(e.path).isFile()}).map(function(e){var t,n;return t=e.key,n=e.path,{key:t,path:n,digest:digest(fs.readFileSync(n,{}))}}),t(c))})})},getRemoteFiles=function(e){var t,n,r,s,c;return t=e.accessKeyId,n=e.bucketName,c=e.secretAccessKey,s=e.region,r=s3({accessKeyId:t,secretAccessKey:c,region:s}),r.listAllObjects({Bucket:n}).then(function(e){return e.map(function(e){return{key:e.Key,digest:JSON.parse(e.ETag)}})})},getUploadFiles=function(e,t){return e.filter(function(e){return t.every(function(t){return e.key!==t.key||e.digest!==t.digest})})},uploadFiles=function(e,t){var n,r,s,c,i;return n=t.accessKeyId,r=t.bucketName,i=t.secretAccessKey,c=t.region,s=s3({accessKeyId:n,secretAccessKey:i,region:c}),s.putAllObjects(e,{Bucket:r})},module.exports=function(e,t){var n,r,s,c;return null==t.cwd&&(t.cwd=process.cwd()),null==t.bucketName&&(t.bucketName=null),null==t.accessKeyId&&(t.accessKeyId=process.env.AWS_ACCESS_KEY_ID),null==t.secretAccessKey&&(t.secretAccessKey=process.env.AWS_SECRET_ACCESS_KEY),null==t.region&&(t.region=null!=(r=process.env.AWS_REGION)?r:"ap-northeast-1"),n=[],s=[],c=[],Promise.resolve().then(function(){return getLocalFiles(e,{cwd:t.cwd})}).then(function(e){return n=e}).then(function(){return getRemoteFiles(t)}).then(function(e){return s=e}).then(function(){return getUploadFiles(n,s)}).then(function(e){return c=e}).then(function(){return uploadFiles(c,t)})};